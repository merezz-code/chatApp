{% extends 'chat/base.html' %}

{% block title %}{{ room.name }} - ChatApp{% endblock %}
{% block body_class %}chat-page{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- CHAT HEADER -->
    <div class="chat-header">
        <a href="{% url 'home' %}" class="btn-back">
            <i class="fas fa-arrow-left fa-lg"></i>
        </a>
        <div class="chat-header-avatar">
            <i class="fas fa-users"></i>
        </div>
        <div class="chat-header-info">
            <div class="chat-header-title">{{ room.name }}</div>
            <div class="chat-header-subtitle">
                <i class="fas fa-users"></i> <span id="online-count">{{ room.get_online_count }}</span>
                <span class="membre-item" data-bs-toggle="modal" data-bs-target="#membreItemModal"> Membres en ligne </span>
            </div>
        </div>
        <div class="chat-header-menu">
            <i class="fas fa-ellipsis-v" id="menuToggle" style="cursor:pointer;"></i>
            <div class="menu-dropdown" id="menuDropdown">
                <div class="menu-item" onclick="leaveGroup()">Quitter le groupe</div>
                {% if user == room.created_by %}
                    <div class="menu-item" data-bs-toggle="modal" data-bs-target="#membreModal"> Ajouter nouveau membre</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- MESSAGES -->
    <div id="chat-messages" class="chat-messages">
        {% for message in messages %}
        <div class="message-wrapper {% if message.user == user %}sent{% else %}received{% endif %}" id="msg-{{ message.id }}">
            <div class="message-bubble {% if message.user == user %}sent{% else %}received{% endif %}">
                {% if message.user != user %}
                    <div class="message-sender">{{ message.user.username }}</div>
                {% endif %}
                <div class="message-text">{{ message.content }}</div>
                {% if message.image %}
                    <img src="{{ message.image.url }}" class="message-image img-fluid" alt="Image">
                {% endif %}
                {% if message.file %}
                    <div class="mt-2">
                        <a href="{{ message.file.url }}" style="color: inherit;" download>
                            <i class="fas fa-file"></i> Fichier joint
                        </a>
                    </div>
                {% endif %}
                <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
            </div>
            {% if message.user == user %}
            <a href="#"
               class="icon-link icon-link-hover text-danger text-decoration-none delete-btn delete"
               data-id="{{ message.id }}"
               data-bs-toggle="modal"
               data-bs-target="#deleteModal">
                <i class="fas fa-trash"></i>
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- INPUT -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="btn-icon emoji-button" id="emoji-button" type="button" title="Emojis">
                <i class="far fa-smile"></i>
            </button>
            <emoji-picker id="emoji-picker"
                          style="display:none; position:absolute; bottom:70px; left:60px; z-index:1000;">
            </emoji-picker>

            <label for="file-upload" class="btn-icon file-upload-label" title="Joindre Fichier ou Image">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file"
                   id="file-upload"
                   class="file-input"
                   accept="image/*, .pdf, .zip, .docx"
                   hidden>
            <div id="file-preview" style="margin-top: 8px; max-height: 100px; overflow-y: auto;"></div>

            <input type="text"
                   id="message-input"
                   class="chat-input"
                   placeholder="Tapez un message..."
                   autocomplete="off">

            <button class="btn-send" id="send-button" type="button" title="Envoyer">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- MODAL DELETE -->
<div class="modal fade" id="deleteModal" tabindex="-1"
     aria-labelledby="deleteModalLabel"
     data-bs-backdrop="static"
     data-bs-keyboard="false">

  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmation de suppression</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Voulez-vous vraiment supprimer ce message ?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const roomName = "{{ room.name }}";
const username = "{{ user.username }}";
const adminUsername = "{{ room.created_by.username }}";
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const fileInput = document.getElementById('file-upload');
const filePreview = document.getElementById('file-preview');
const emojiButton = document.getElementById('emoji-button');
const emojiPicker = document.getElementById('emoji-picker');

let selectedFile = null;
let messageIdToDelete = null;

const chatSocket = new WebSocket(
    (window.location.protocol === 'https:' ? 'wss:' : 'ws:') +
    "//" + window.location.host + "/ws/chat/room/" + roomName + "/"
);

// --- UTILS ---
function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
function scrollToBottom(){
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// --- MESSAGE DOM ---
function addMessage(user, message, timestamp, id){
    const isSent = user === username;
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    wrapper.id = `msg-${id}`;

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
    let html = '';
    if(!isSent) html += `<div class="message-sender">${escapeHtml(user)}</div>`;
    html += `<div class="message-text">${escapeHtml(message)}</div>`;
    html += `<div class="message-time">${timestamp}</div>`;
    bubble.innerHTML = html;
    wrapper.appendChild(bubble);

    if(isSent){
        const a = document.createElement('a');
        a.href="#";
        a.className="icon-link icon-link-hover text-danger text-decoration-none delete-btn delete";
        a.dataset.id=id;
        a.setAttribute('data-bs-toggle','modal');
        a.setAttribute('data-bs-target','#deleteModal');
        a.innerHTML='<i class="fas fa-trash"></i>';
        a.addEventListener('click', handleDeleteClick);
        wrapper.appendChild(a);
    }

    chatMessages.appendChild(wrapper);
    scrollToBottom();
}

// --- DELETE ---

// Lors du clic sur l'ic√¥ne delete (les liens ont data-id="{{ message.id }}")
// on enregistre l'id et on ouvre le modal (Bootstrap le fait via data-bs-*)
function handleDeleteClick(e){
    e.preventDefault();
    messageIdToDelete = this.dataset.id;
    console.log("me" + messageIdToDelete)
    // focus sur le bouton pour accessibilit√© si voulu
    // document.getElementById('confirmDeleteBtn').focus();
}
document.querySelectorAll('.delete-btn').forEach(link => link.addEventListener('click', handleDeleteClick));

// Bouton confirmer suppression dans le modal
document.getElementById('confirmDeleteBtn').addEventListener('click', ()=>{
    if(!messageIdToDelete) return;

    // on blur le bouton pour √©viter le warning aria-hidden
    const btn = document.getElementById('confirmDeleteBtn');
    if(btn) btn.blur();

    // envoi AU SERVEUR : server supprime en base et broadcast
    chatSocket.send(JSON.stringify({
        action: 'delete_message',
        message_id: messageIdToDelete
    }));

    // vider la variable et fermer le modal proprement
    messageIdToDelete = null;
    const modalEl = document.getElementById('deleteModal');
    const bsModal = bootstrap.Modal.getInstance(modalEl);
    if(bsModal) bsModal.hide();
});
// --- SEND MESSAGE ---
function sendMessage(){
    const messageText = messageInput.value.trim();
    if(selectedFile){
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('room', roomName);
        fetch("{% url 'upload_file' %}",{
            method:'POST',
            headers:{'X-CSRFToken':'{{ csrf_token }}'},
            body: formData
        }).then(res=>res.json()).then(data=>{
            if(data.status==='success'){
                if(messageText){
                    chatSocket.send(JSON.stringify({'message':messageText,'action':'message'}));
                }
                selectedFile=null;
                filePreview.innerHTML='';
                messageInput.value='';
            }else{alert(data.message);}
        }).catch(err=>console.error(err));
    }else if(messageText){
        chatSocket.send(JSON.stringify({'message':messageText,'action':'message'}));
        messageInput.value='';
    }
}
sendButton.onclick = sendMessage;
messageInput.addEventListener('keypress', e=>{
    if(e.key==='Enter'){e.preventDefault(); sendMessage();}
});

// --- FILE UPLOAD ---
fileInput.addEventListener('change', function(){
    filePreview.innerHTML='';
    selectedFile = this.files[0];
    if(!selectedFile) return;
    const p = document.createElement('p');
    p.textContent='üìé '+selectedFile.name;
    filePreview.appendChild(p);
    if(selectedFile.type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(selectedFile);
        img.style.maxWidth='100px';
        img.style.maxHeight='80px';
        img.style.marginTop='4px';
        filePreview.appendChild(img);
    }
});

// --- EMOJI ---
emojiButton.addEventListener('click', ()=>{
    emojiPicker.style.display = (emojiPicker.style.display==='none'||emojiPicker.style.display==='') ? 'block' : 'none';
});
emojiPicker.addEventListener('emoji-click', event=>{
    messageInput.value += event.detail.unicode;
});
document.addEventListener('click', e=>{
    if(!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)){
        emojiPicker.style.display='none';
    }
});

// --- MENU ---
const menuToggle = document.getElementById('menuToggle');
const menuDropdown = document.getElementById('menuDropdown');
menuToggle.addEventListener('click', ()=>{menuDropdown.style.display=menuDropdown.style.display==='block'?'none':'block';});
document.addEventListener('click', e=>{
    if(!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) menuDropdown.style.display='none';
});

// --- LEAVE GROUP ---
function leaveGroup(){
    if(confirm("√ätes-vous s√ªr de vouloir quitter ce salon ?")){
        chatSocket.send(JSON.stringify({'action':'leave_group'}));
    }
}

// --- WEBSOCKET ---
chatSocket.onmessage = function(e){
    const data = JSON.parse(e.data);
    if(data.type==='message'){
        addMessage(data.username, data.message, data.timestamp, data.id);
    }
    if(data.type==='delete_message'){
        const msg = document.getElementById("msg-"+data.message_id);
        if(msg) msg.remove();
    }
    if(data.type==='members_update'){
        const countElem=document.getElementById('online-count');
        if(countElem && data.members_data) countElem.textContent=data.members_data.count;
    }
    scrollToBottom();
};
chatSocket.onclose = function(e){console.error('Chat socket closed unexpectedly');};
</script>

<style>
.message-wrapper{position:relative;}
.delete-btn{position:absolute;top:5px;right:5px;display:none;}
.message-wrapper:hover .delete-btn{display:block;}
</style>
{% endblock %}
