{% extends 'chat/base.html' %}

{% block title %}{{ room.name }} - ChatApp{% endblock %}
{% block body_class %}chat-page{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- CHAT HEADER -->
    <div class="chat-header">
        <a href="{% url 'home' %}" class="btn-back">
            <i class="fas fa-arrow-left fa-lg"></i>
        </a>
        <div class="chat-header-avatar">
            <i class="fas fa-users"></i>
        </div>
        <div class="chat-header-info">
            <div class="chat-header-title">{{ room.name }}</div>
            <div class="chat-header-subtitle">
                <i class="fas fa-users"></i> <span id="online-count">{{ room.get_online_count }}</span>
                <span class="membre-item" data-bs-toggle="modal" data-bs-target="#membreItemModal"> Membres en ligne </span>
            </div>
        </div>
        <div class="chat-header-menu">
            <i class="fas fa-ellipsis-v" id="menuToggle" style="cursor:pointer;"></i>
            <div class="menu-dropdown" id="menuDropdown">
                <div class="menu-item" onclick="leaveGroup()">Quitter le groupe</div>
                {% if user == room.created_by %}
                    <div class="menu-item" data-bs-toggle="modal" data-bs-target="#membreModal"> Ajouter nouveau membre</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- MESSAGES -->
    <div id="chat-messages" class="chat-messages">
        {% for message in messages %}
        <div class="message-wrapper {% if message.user == user %}sent{% else %}received{% endif %}" id="msg-{{ message.id }}">
            <div class="message-bubble {% if message.user == user %}sent{% else %}received{% endif %}">
                {% if message.user != user %}
                    <div class="message-sender">{{ message.user.username }}</div>
                {% endif %}
                <div class="message-text">{{ message.content }}</div>
                {% if message.image %}
                    <img src="{{ message.image.url }}" class="message-image img-fluid" alt="Image">
                {% endif %}
                {% if message.file %}
                    <div class="mt-2">
                        <a href="{{ message.file.url }}" style="color: inherit;" download>
                            <i class="fas fa-file"></i> Fichier joint
                        </a>
                    </div>
                {% endif %}
                <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
            </div>
            {% if message.user == user %}
            <a href="#"
               class="icon-link icon-link-hover text-danger text-decoration-none delete-btn delete"
               data-id="{{ message.id }}"
               data-bs-toggle="modal"
               data-bs-target="#deleteModal">
                <i class="fas fa-trash"></i>
            </a>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- INPUT -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="btn-icon emoji-button" id="emoji-button" type="button" title="Emojis">
                <i class="far fa-smile"></i>
            </button>
            <emoji-picker id="emoji-picker"
                          style="display:none; position:absolute; bottom:70px; left:60px; z-index:1000;">
            </emoji-picker>

            <label for="file-upload" class="btn-icon file-upload-label" title="Joindre Fichier ou Image">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file"
                   id="file-upload"
                   class="file-input"
                   accept="image/*, .pdf, .zip, .docx"
                   hidden>
            <div id="file-preview" style="margin-top: 8px; max-height: 100px; overflow-y: auto;"></div>

            <input type="text"
                   id="message-input"
                   class="chat-input"
                   placeholder="Tapez un message..."
                   autocomplete="off">

            <button class="btn-send" id="send-button" type="button" title="Envoyer">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<!-- MODAL DELETE -->
<div class="modal fade" id="deleteModal" tabindex="-1"
     aria-labelledby="deleteModalLabel"
     data-bs-backdrop="static"
     data-bs-keyboard="false">

  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmation de suppression</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Voulez-vous vraiment supprimer ce message ?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="membreModal" tabindex="-1" aria-labelledby="sidebarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-sidebar">
            {% if membre_contact %}
                <div class="modal-chat-list mt-2">
                    <div class="section-divider"><i class="fas fa-user"></i> Utilisateurs</div>
                    {% for user in membre_contact %}
                        <div class="user-list-item">
                            <div class="chat-avatar"><i class="fas fa-user"></i></div>
                            <div class="chat-info">
                                <div class="chat-name">{{ user.username }}</div>
                            </div>

                            <button type="button" class="add-user-btn"
                                    onclick="addMember('{{ user.username }}')">
                                <i class="fas fa-plus-circle"></i>
                            </button>
                            </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-center mt-2 text-secondary">Aucun utilisateur disponible</p>
            {% endif %}
                <div class="modal-footer">
                    <button class="btn-cancel" data-bs-dismiss="modal">Annuler</button>
                </div>
          </div>
</div>
</div>

<div class="modal fade" id="membreItemModal" tabindex="-1" aria-labelledby="sidebarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-sidebar">
             <div class="modal-chat-list mt-2" id="member-list-container">
                 <div class="section-divider"><i class="fas fa-user"></i> Les membres du group </div>
                 <div id="member-list-items">
                     {% if members_list %}
                       {% for member in members_list %}
                             <div class="user-list-item">
                                 <div class="chat-avatar"><i class="fas fa-user"></i></div>
                                 <div class="chat-info">
                                     <div class="chat-name">{{ member.username }}</div>
                                 </div>
                                 {% if user == room.created_by and member != room.created_by %}
                                     <button onclick="removeMember('{{ member.username }}')"
                                             class="remove-btn"
                                             value="{{ member }}">
                                         <i class="fa-solid fa-circle-minus"></i>
                                     </button>
                                 {% endif %}
                             </div>
                         {% endfor %}
                     {% else %}
                         <p class="text-center mt-2 text-secondary">Aucun Membre disponible</p>
                     {% endif %}

                 </div>
             </div>
            <div class="modal-footer">
                    <button class="btn-cancel" data-bs-dismiss="modal">Annuler</button>
             </div>
        </div>
    </div>
</div>

<div id="monModalErreur" class="modal-overlay">
    <div class="modal-contenu">
        <span class="modal-fermer" id="fermerModal">&times;</span>
        <h3>Erreur</h3>
        <p id="modalMessageTexte"></p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const roomName = "{{ room.name }}";
const username = "{{ user.username }}";
const adminUsername = "{{ room.created_by.username }}";
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const fileInput = document.getElementById('file-upload');
const filePreview = document.getElementById('file-preview');
const emojiButton = document.getElementById('emoji-button');
const emojiPicker = document.getElementById('emoji-picker');

let selectedFile = null;
let messageIdToDelete = null;

const chatSocket = new WebSocket(
    (window.location.protocol === 'https:' ? 'wss:' : 'ws:') +
    "//" + window.location.host + "/ws/chat/room/" + encodeURIComponent(roomName) + "/"
);


const modal = document.getElementById('monModalErreur');
const messageElement = document.getElementById('modalMessageTexte');
const spanFermer = document.getElementById('fermerModal');

// --- UTILS ---
function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
function scrollToBottom(){
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// --- MESSAGE DOM ---
function addMessage(user, message, timestamp, id){
    const isSent = user === username;
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
    wrapper.id = `msg-${id}`;

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
    let html = '';
    if(!isSent) html += `<div class="message-sender">${escapeHtml(user)}</div>`;
    html += `<div class="message-text">${escapeHtml(message)}</div>`;
    html += `<div class="message-time">${timestamp}</div>`;
    bubble.innerHTML = html;
    wrapper.appendChild(bubble);

    if(isSent){
        const a = document.createElement('a');
        a.href="#";
        a.className="icon-link icon-link-hover text-danger text-decoration-none delete-btn delete";
        a.dataset.id=id;
        a.setAttribute('data-bs-toggle','modal');
        a.setAttribute('data-bs-target','#deleteModal');
        a.innerHTML='<i class="fas fa-trash"></i>';
        a.addEventListener('click', handleDeleteClick);
        wrapper.appendChild(a);
    }

    chatMessages.appendChild(wrapper);
    scrollToBottom();
}

// --- DELETE ---
function handleDeleteClick(e){
    e.preventDefault();
    const id = this.dataset.id;
    if(!id){
        console.error("Impossible de r√©cup√©rer l'ID du message !");
        return;
    }
    messageIdToDelete = id;
}

document.querySelectorAll('.delete-btn').forEach(link => link.addEventListener('click', handleDeleteClick));

document.getElementById('confirmDeleteBtn').addEventListener('click', ()=>{
    if(!messageIdToDelete) return;

    const btn = document.getElementById('confirmDeleteBtn');
    if(btn) btn.blur(); // √©viter warning aria-hidden

   if (messageIdToDelete === undefined || messageIdToDelete === null) {
    console.error("Erreur : messageIdToDelete est undefined ou null !");
    afficherModalErreur("Impossible de supprimer ce message. ID invalide.");
    return;  // on n‚Äôenvoie pas le message
}

if(chatSocket.readyState === WebSocket.OPEN){
    chatSocket.send(JSON.stringify({
        action: 'delete_message',
        message_id: messageIdToDelete
    }));
} else {
    afficherModalErreur("Connexion au chat non √©tablie. R√©essayez plus tard.");
}


    messageIdToDelete = null;
    const modalEl = document.getElementById('deleteModal');
    const bsModal = bootstrap.Modal.getInstance(modalEl);
    if(bsModal) bsModal.hide();
});

// --- SEND MESSAGE ---
function sendMessage(){
    const messageText = messageInput.value.trim();

    if(selectedFile){
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('room', roomName);
        fetch("{% url 'upload_file' %}",{
            method:'POST',
            headers:{'X-CSRFToken':'{{ csrf_token }}'},
            body: formData
        }).then(res=>res.json()).then(data=>{
            if(data.status==='success'){
                if(messageText && chatSocket.readyState === WebSocket.OPEN){
                    chatSocket.send(JSON.stringify({'message':messageText,'action':'message'}));
                }
                selectedFile=null;
                filePreview.innerHTML='';
                messageInput.value='';
            }else{alert(data.message);}
        }).catch(err=>console.error(err));
    }else if(messageText){
        if(chatSocket.readyState === WebSocket.OPEN){
            chatSocket.send(JSON.stringify({'message':messageText,'action':'message'}));
            messageInput.value='';
        } else {
            afficherModalErreur("Connexion au chat non √©tablie. R√©essayez plus tard.");
        }
    }
}
sendButton.onclick = sendMessage;
messageInput.addEventListener('keypress', e=>{
    if(e.key==='Enter'){e.preventDefault(); sendMessage();}
});

// --- FILE UPLOAD ---
fileInput.addEventListener('change', function(){
    filePreview.innerHTML='';
    selectedFile = this.files[0];
    if(!selectedFile) return;
    const p = document.createElement('p');
    p.textContent='üìé '+selectedFile.name;
    filePreview.appendChild(p);
    if(selectedFile.type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(selectedFile);
        img.style.maxWidth='100px';
        img.style.maxHeight='80px';
        img.style.marginTop='4px';
        filePreview.appendChild(img);
    }
});

// --- EMOJI ---
emojiButton.addEventListener('click', ()=>{
    emojiPicker.style.display = (emojiPicker.style.display==='none'||emojiPicker.style.display==='') ? 'block' : 'none';
});
emojiPicker.addEventListener('emoji-click', event=>{
    messageInput.value += event.detail.unicode;
});
document.addEventListener('click', e=>{
    if(!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)){
        emojiPicker.style.display='none';
    }
});

// --- MENU ---
const menuToggle = document.getElementById('menuToggle');
const menuDropdown = document.getElementById('menuDropdown');
menuToggle.addEventListener('click', ()=>{
    menuDropdown.style.display=menuDropdown.style.display==='block'?'none':'block';
});
// fermer menu si clic dehors
document.addEventListener('click', e=>{
    if(!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) menuDropdown.style.display='none';
});
// fermer menu si clic sur item
menuDropdown.querySelectorAll('.menu-item').forEach(item=>{
    item.addEventListener('click', ()=>{ menuDropdown.style.display='none'; });
});

// --- LEAVE GROUP ---
function leaveGroup(){
    if(confirm("√ätes-vous s√ªr de vouloir quitter ce salon ?")){
        if(chatSocket.readyState === WebSocket.OPEN){
            chatSocket.send(JSON.stringify({'action':'leave_group'}));
        } else {
            afficherModalErreur("Connexion au chat non √©tablie. R√©essayez plus tard.");
        }
    }
}

// --- SYSTEM MESSAGE ---
function addSystemMessage(message) {
    const div = document.createElement('div');
    div.className = 'system-message';
    div.innerHTML = `<span class="system-message-bubble">${escapeHtml(message)}</span>`;
    chatMessages.appendChild(div);
}

// --- MEMBERS MODAL ---
function rebuildMemberList(members) {
    const listContainer = document.getElementById('member-list-items');
    if (!listContainer) return;
    listContainer.innerHTML = '';

    if (!members || members.length === 0) {
        listContainer.innerHTML = '<p class="text-center mt-2 text-secondary">Aucun Membre disponible</p>';
        return;
    }

    members.forEach(member => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'user-list-item';
        itemDiv.id = `member-item-${member.username}`;

        let itemHtml = `
            <div class="chat-avatar"><i class="fas fa-user"></i></div>
            <div class="chat-info">
                <div class="chat-name">${escapeHtml(member.username)}</div>
            </div>
        `;

        if (username === adminUsername && member.username !== adminUsername) {
            itemHtml += `
                <button type="button" class="remove-btn"
                        onclick="removeMember('${escapeHtml(member.username)}')">
                    <i class="fa-solid fa-circle-minus"></i>
                </button>
            `;
        }
        itemDiv.innerHTML = itemHtml;
        listContainer.appendChild(itemDiv);
    });
}

function removeMember(usernameToRemove) {
    if(chatSocket.readyState === WebSocket.OPEN){
        if (confirm(`√ätes-vous s√ªr de vouloir retirer ${usernameToRemove} du salon ?`)) {
            console.log(`Envoi de la demande de suppression pour: ${usernameToRemove}`);
            chatSocket.send(JSON.stringify({
                'action': 'remove_member',
                'username': usernameToRemove
            }));
            const modalEl = document.getElementById('membreItemModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
        }
    } else {
        afficherModalErreur("Connexion au chat non √©tablie. R√©essayez plus tard.");
    }
}

function addMember(usernameToAdd) {
    if(chatSocket.readyState === WebSocket.OPEN){
        console.log(`Demande d'ajout pour: ${usernameToAdd}`);
        chatSocket.send(JSON.stringify({
            'action': 'add_member',
            'username': usernameToAdd
        }));
        const modalEl = document.getElementById('membreModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
    } else {
        afficherModalErreur("Connexion au chat non √©tablie. R√©essayez plus tard.");
    }
}

// --- MODAL ERREUR ---
function afficherModalErreur(message) {
    messageElement.textContent = message;
    modal.style.display = 'block';
}

spanFermer.onclick = function() {
    modal.style.display = 'none';
}
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// --- WEBSOCKET ---
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.type === 'message') {
        addMessage(data.username, data.message, data.timestamp);
    }
    else if (data.type === 'members_update') {
        if (data.message) addSystemMessage(data.message);

        const countElement = document.getElementById('online-count');
        if (countElement && data.members_data) countElement.textContent = data.members_data.count;

        if (data.members_data) rebuildMemberList(data.members_data.members);

        if (data.username_removed === username) {
            alert("Vous avez √©t√© retir√© du salon.");
            window.location.href = "{% url 'home' %}";
        }
    }
    else if (data.type === 'group_left_you') {
        alert(data.message);
        window.location.href = "{% url 'home' %}";
    }
    else if (data.type === "error"){
        afficherModalErreur(data.message);
    }
    else if(data.type === 'delete_message'){
    const msgEl = document.getElementById('msg-'+data.message_id);
    if(msgEl) msgEl.remove();
}

    scrollToBottom();
};

chatSocket.onclose = function(e){
    console.error('Chat socket closed unexpectedly');
};
</script>
<style>
.message-wrapper{position:relative;}
.delete-btn{position:absolute;top:5px;right:5px;display:none;}
.message-wrapper:hover .delete-btn{display:block;}
</style>
{% endblock %}


