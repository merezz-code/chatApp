<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ChatApp{% endblock %}</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'chat/css/global.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/home.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/login.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/register.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/private_chat.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/room.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/create_room.css' %}">
    <link href="{% static 'chat/css/bootstrap.css' %}" rel="stylesheet">
    <link href="{% static 'chat/css/all.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.19.0/index.min.css">

</head>
<body class="{% block body_class %}{% endblock %}">
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}">
                <i class="fas fa-comment-dots"></i> MNS ChatApp
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <button type="button" class="btn-new-chat nav-link" data-bs-toggle="modal" data-bs-target="#ProfileModal">
                                {% if user.profile.avatar %}
                                    <img id="avatar-preview" src="{{ user.profile.avatar.url }}" alt="Avatar">
                                {% else %}
                                    <div>
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                {% endif %} {{ user.username }}
                            </button>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt"></i> Déconnexion
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'login' %}">Connexion</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'register' %}">Inscription</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-wrapper">
        {% if messages %}
            <div class="position-fixed top-0 start-50 translate-middle-x mt-5 px-3" style="z-index: 9999; width: 100%; max-width: 500px;">
                {% for message in messages %}

                {% endfor %}
            </div>
        {% endif %}

        {% block content %}{% endblock %}
    </div>
<div class="modal fade" id="ProfileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-profile">
      <form method="POST" action="{% url 'update_profile' %}" enctype="multipart/form-data" class="profile-inline-form">
        {% csrf_token %}

        <div class="modal-header profile-header">
          <h5 class="modal-title ">Mon Profil</h5>
          <button type="button" class="btn-close-profile" data-bs-dismiss="modal" aria-label="Fermer">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body profile-body">
          <div class="profile-avatar-section text-center mb-4">
            <div class="position-relative d-inline-block">
                <div class="profile-avatar-large">
                  {% if user.profile.avatar %}
                    <img id="avatar-preview" src="{{ user.profile.avatar.url }}" alt="Avatar">
                  {% else %}
                    <div>
                        <i class="fas fa-user fa-3x text-secondary"></i>
                    </div>
                    {% endif %}
                </div>

                <label for="id_avatar" class="btn-edit-avatar">
                    <i class="fas fa-camera"></i>
                </label>
                <input type="file" id="id_avatar" name="avatar" accept="image/*" style="display: none;">
            </div>
          </div>

          <div class="profile-section mb-3">
            <div class="profile-section-header">
              <span class="profile-label">Nom d'utilisateur</span>
            </div>
            <div class="profile-section-content">
              <input type="text" class="form-control-plaintext" value="{{ user.username }}" readonly>
              <small class="text-muted">Ce nom est votre identifiant unique.</small>
            </div>
          </div>

          <div class="profile-section mb-3">
            <div class="profile-section-header">
              <span class="profile-label">À propos (Bio)</span>
            </div>
            <div class="profile-section-content">
              {{ form.bio }} <i class="fas fa-pencil-alt"></i>
            </div>
          </div>

          <div class="profile-section">
            <div class="profile-section-header">
              <span class="profile-label">Téléphone</span>
            </div>
            <div class="profile-section-content">
              {{ form.phone }}
              <i class="fas fa-pencil-alt text-muted ms-2"></i>
            </div>
          </div>

            <div class="profile-section">
            <div class="profile-section-header">
              <span class="profile-label">Email</span>
            </div>
            <div class="profile-section-content">
              {{ form.email }}
              <i class="fas fa-pencil-alt text-muted ms-2"></i>
            </div>
          </div>
        </div>

        <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-success">Enregistrer</button>
        </div>

      </form>
    </div>
  </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.19.0/index.js" type="module"></script>

    <script>
        console.log('haha');
        document.addEventListener('DOMContentLoaded', function() {
            const avatarInput = document.getElementById('id_avatar');
            const avatarPreview = document.getElementById('avatar-preview');
            const defaultIconContainer = avatarPreview ? null : document.querySelector('.profile-avatar-large > div');

            if (avatarInput) {
                avatarInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {

                            // 1. Créer ou mettre à jour l'élément <img>
                            if (!avatarPreview) {
                                // Si l'image n'existait pas avant (icône par défaut affichée)
                                const img = document.createElement('img');
                                img.id = 'avatar-preview';
                                img.src = event.target.result;
                                img.alt = "Nouvel Avatar";

                                // Remplacer l'icône par l'image
                                const parent = defaultIconContainer.parentElement;
                                parent.removeChild(defaultIconContainer);
                                parent.appendChild(img);

                            } else {
                                // Si l'image existait déjà
                                avatarPreview.src = event.target.result;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
         });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
