{% extends 'chat/base.html' %}
{% load static %}

<audio id="notifSound" src="{% static 'chat/sounds/sound.mp3' %}" preload="auto"></audio>

{% block content %}
<div class="whatsapp-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h5><i class="fas fa-comments"></i> Conversations
                <span id="total-unread-badge" class="chat-badge" style="display: none;">0</span>
            </h5>
            <button type="button" class="btn-new-chat" data-bs-toggle="modal" data-bs-target="#sidebarModal">
                <i class="fas fa-plus-circle"></i>
            </button>
        </div>
        <div class="chat-list">
            <div class="section-divider"><i class="fas fa-hashtag"></i> SALONS DE DISCUSSION</div>
            {% for room in user_rooms %}
            <a href="{% url 'room_detail' room.name %}" class="chat-item">
                <div class="chat-avatar"><i class="fas fa-users"></i></div>
                <div class="chat-info">
                    <div class="chat-name">{{ room.name }}</div>
                    <div class="chat-description">{{ room.description|default:"Aucune description"|truncatewords:8 }}</div>
                </div>
                <div class="chat-meta">
                    <div class="chat-time">{{ room.created_at|date:"H:i" }}</div>
                    {% for r in rooms_data %}
                        {% if r.id == room.id and r.unread_count > 0 %}
                            <div class="chat-badge group-unread-badge" id="room-badge-{{ r.id }}">{{ r.unread_count }}</div>
                        {% endif %}
                    {% endfor %}
                </div>
            </a>
            {% endfor %}

            {% if private_chats %}
            <div class="section-divider"><i class="fas fa-user"></i> MESSAGES PRIVÉS</div>
            {% for chat in private_chats %}
            <div class="chat-item-wrapper" id="conversation-{{ chat.user.id }}" data-username="{{ chat.user.username }}">
                <a href="{% url 'private_chat' chat.user.username %}" class="chat-item">
                    <div class="chat-avatar"><i class="fas fa-user"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">{{ chat.user.username }}</div>
                        <div class="chat-description">
                            {% if chat.user.profile.is_online %}
                                <span class="status-online"><i class="fas fa-circle"></i> En ligne</span>
                            {% else %}
                                <span class="status-offline">Hors ligne</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if chat.unread_count > 0 %}
                    <div class="chat-meta">
                        <div class="chat-badge private-unread-badge">{{ chat.unread_count }}</div>
                    </div>
                    {% endif %}
                </a>
                <div class="chat-overflow">
                    <i class="fas fa-ellipsis-v overflow-btn" data-menu="menu-{{ chat.user.id }}"></i>
                    <div class="menu-dropdown" id="menu-{{ chat.user.id }}">
                        <div class="menu-item" onclick="openDeleteModal('{{ chat.user.id }}', '{{ chat.user.username }}')">Supprimer la discussion</div>
                        <div class="menu-item" onclick="blockUser('{{ chat.user.username }}')">Bloquer</div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
        <div class="welcome-message">
            <i class="fas fa-comment-dots"></i>
            <h3>Bienvenue sur ChatApp</h3>
            <p>Sélectionnez une conversation pour commencer à discuter</p>
        </div>
    </div>
</div>

<!-- Modales sidebar + delete -->
<div class="modal fade" id="sidebarModal" tabindex="-1" aria-labelledby="sidebarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-sidebar">
            <div class="modal-header">
                <h5 class="modal-title" id="sidebarModalLabel">Nouvelle conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="sidebar-header">
                    <h5><i class="fas fa-comments"></i> Salons</h5>
                    <button class="btn-new-chat" onclick="window.location.href='{% url 'create_room' %}'">
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
                {% if rooms %}
                <div class="modal-chat-list">
                    <div class="section-divider"><i class="fas fa-hashtag"></i> Salons disponibles</div>
                    {% for room in rooms %}
                        {% if not room.is_private %}
                        <div class="d-flex justify-content-between align-items-center p-2 room-item">
                            <a href="{% url 'room_detail' room.name %}" class="d-flex align-items-center flex-grow-1">
                                <div class="chat-avatar"><i class="fas fa-users"></i></div>
                                <div class="chat-info">
                                    <div class="chat-name">{{ room.name }}</div>
                                </div>
                            </a>
                            <form action="{% url 'join_room' room.name %}" method="POST">
                                {% csrf_token %}
                                <button class="btn-new-chat"><i class="fas fa-user-plus"></i></button>
                            </form>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                {% if users_not_chatted %}
                <div class="modal-chat-list mt-2">
                    <div class="section-divider"><i class="fas fa-user"></i> Utilisateurs</div>
                    {% for user in users_not_chatted %}
                    <a href="{% url 'private_chat' user.username %}" class="d-flex align-items-center p-2">
                        <div class="chat-avatar"><i class="fas fa-user"></i></div>
                        <div class="chat-info">
                            <div class="chat-name">{{ user.username }}</div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center mt-2 text-secondary">Aucun utilisateur disponible</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" data-bs-dismiss="modal">Annuler</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmation de suppression</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Voulez-vous vraiment supprimer cette discussion ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<!-- Notification toast -->
<div id="notification" class="notification hidden">
    <div class="notification-icon"><i class="fas fa-check-circle"></i></div>
    <div class="notification-content">
        <div class="notification-title">Succès !</div>
        <div class="notification-message">Votre action a été enregistrée avec succès.</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ================== UTILS ================== */
const csrftoken = getCookie("csrftoken");
const audio = document.getElementById("notifSound");
let audioUnlocked = false;

function getCookie(name){
    let cookieValue = null;
    document.cookie.split(';').forEach(c=>{
        c=c.trim();
        if(c.startsWith(name+'=')) cookieValue = decodeURIComponent(c.substring(name.length+1));
    });
    return cookieValue;
}

function attemptAudioUnlock(){
    if(audioUnlocked) return;
    audio.volume=0;
    audio.play().then(()=>{ audio.pause(); audio.currentTime=0; audio.volume=1; audioUnlocked=true; });
    document.removeEventListener("mousedown", attemptAudioUnlock);
    document.removeEventListener("touchstart", attemptAudioUnlock);
}
document.addEventListener("mousedown", attemptAudioUnlock, { once:true });
document.addEventListener("touchstart", attemptAudioUnlock, { once:true });

function playNotificationSound(){
    if(!audioUnlocked) return;
    audio.currentTime=0; audio.play().catch(()=>{ audioUnlocked=false; });
}

function showNotification(message){
    const notif=document.getElementById('notification');
    notif.querySelector('.notification-message').textContent=message;
    notif.classList.remove('hidden');
    setTimeout(()=>notif.classList.add('hidden'),5000);
}

function updateTotalUnreadCount(){
    let total=0;
    document.querySelectorAll('.private-unread-badge, .group-unread-badge').forEach(b=>{
        total += parseInt(b.textContent)||0;
    });
    const totalBadge=document.getElementById('total-unread-badge');
    totalBadge.textContent = total>0?total:'';
    totalBadge.style.display=total>0?'inline-block':'none';
}

/* ================== UNREAD PRIVÉS ================== */
let prevPrivateUnread = {};
function refreshPrivateUnread(){
    fetch("/private/unread-count/").then(res=>res.json()).then(data=>{
        data.private_unread.forEach(item=>{
            const chatItem=document.getElementById(`conversation-${item.user_id}`);
            if(!chatItem) return;
            let badge=chatItem.querySelector('.private-unread-badge');
            if(badge) badge.remove();
            if(item.count>0){
                badge=document.createElement('div');
                badge.className='chat-badge private-unread-badge';
                badge.textContent=item.count;
                let meta=chatItem.querySelector('.chat-meta')||chatItem.querySelector('a.chat-item').appendChild(document.createElement('div'));
                meta.className='chat-meta';
                meta.appendChild(badge);
                if(!prevPrivateUnread[item.user_id] || item.count>prevPrivateUnread[item.user_id]){
                    playNotificationSound();
                    showNotification(`Nouveaux messages de ${item.name} (${item.count})`);
                }
            }
            prevPrivateUnread[item.user_id]=item.count;
        });
        updateTotalUnreadCount();
    }).catch(console.error);
}

/* ================== UNREAD GROUPES ================== */
let prevGroupUnread={};
function refreshGroupUnread(){
    fetch("/rooms/unread-count/").then(res=>res.json()).then(data=>{
        data.rooms.forEach(item=>{
            const badge=document.getElementById(`room-badge-${item.id}`);
            if(!badge) return;
            badge.textContent=item.unread_count>0?item.unread_count:'';
            badge.style.display=item.unread_count>0?'block':'none';
            if(!prevGroupUnread[item.id]) prevGroupUnread[item.id]=0;
            if(item.unread_count>prevGroupUnread[item.id]){
                playNotificationSound();
                showNotification(`Nouveaux messages dans ${item.name} (${item.unread_count})`);
            }
            prevGroupUnread[item.id]=item.unread_count;
        });
        updateTotalUnreadCount();
    }).catch(console.error);
}

/* ================== REFRESH ================== */
setInterval(()=>{ refreshPrivateUnread(); refreshGroupUnread(); },3000);
document.addEventListener('DOMContentLoaded',()=>{ refreshPrivateUnread(); refreshGroupUnread(); updateTotalUnreadCount(); });

/* ================== MENU 3 POINTS ================== */
document.querySelectorAll(".overflow-btn").forEach(btn=>{
    btn.addEventListener("click",function(e){
        e.stopPropagation();
        const menuId=this.getAttribute("data-menu");
        const menu=document.getElementById(menuId);
        document.querySelectorAll(".menu-dropdown").forEach(m=>{ if(m!==menu) m.style.display="none"; });
        menu.style.display=menu.style.display==="block"?"none":"block";
    });
});
document.addEventListener("click",()=>{ document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none"); });

/* ================== SUPPRESSION ================== */
let deletingUserId=null;
let deletingUsername=null;
function openDeleteModal(userId,username){ deletingUserId=userId; deletingUsername=username; new bootstrap.Modal(document.getElementById("deleteModal")).show(); }
document.getElementById("confirmDeleteBtn").addEventListener("click",()=>{
    if(!deletingUserId) return;
    fetch(`/private/delete/${deletingUserId}/`,{ method:"DELETE", headers:{"X-CSRFToken":csrftoken} })
    .then(res=>res.json()).then(data=>{
        if(data.status==="success"){
            const el=document.getElementById(`conversation-${deletingUserId}`);
            if(el) el.remove();
            bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide();
        } else console.log("Erreur: "+data.message);
    }).catch(()=>console.log("Erreur réseau"));
});

/* ================== BLOQUER UTILISATEUR ================== */
function blockUser(username){
    if(!confirm(`Voulez-vous vraiment bloquer ${username} ?`)) return;
    fetch(`/private/block/${username}/`,{ method:"POST", headers:{"X-CSRFToken":csrftoken} })
    .then(res=>res.json()).then(data=>{
        if(data.status==="success"){
            const el=document.querySelector(`.chat-item-wrapper[data-username="${username}"]`);
            if(el) el.remove();
        } else console.log("Erreur: "+data.message);
    });
}
</script>

<style>
/* --- Styles conservés --- */
.chat-item-wrapper { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); position: relative; }
.chat-item-wrapper a.chat-item { flex: 1; display: flex; align-items: center; gap: 15px; text-decoration: none; color: inherit; min-width: 0; }
.chat-overflow { width: auto; cursor: pointer; position: relative; padding: 5px; opacity: 0; transition: opacity 0.2s ease; }
.menu-dropdown { display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); padding: 5px 0; width: max-content; z-index: 100; white-space: nowrap; }
.chat-item-wrapper:hover .chat-overflow { opacity: 1; }

:root{--success-color:#A27B5C;--background-color:#fff;--shadow:rgba(0,0,0,0.2);}
.notification{position:fixed;top:20px;right:20px;display:flex;align-items:center;padding:15px 20px;width:300px;background-color:var(--background-color);border-left:5px solid var(--success-color);border-radius:8px;box-shadow:0 4px 12px var(--shadow);opacity:1;transition:opacity 0.3s ease,transform 0.3s ease;z-index:1000;}
.notification.hidden{opacity:0;transform:translateX(100%);pointer-events:none;}
.notification-icon{color:var(--success-color);font-size:20px;margin-right:15px;}
.notification-content{flex-grow:1;}
.notification-title{font-weight:bold;color:#333;font-size:14px;margin-bottom:2px;}
.notification-message{color:#555;font-size:13px;}
#total-unread-badge{margin-left:8px;font-size:10px;padding:2px 6px;line-height:1;background-color:#f00;color:white;border-radius:50%;font-weight:bold;}
</style>
{% endblock %}
