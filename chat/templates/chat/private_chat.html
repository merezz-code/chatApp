{% extends 'chat/base.html' %}

{% block title %}{{ other_user.username }} - ChatApp{% endblock %}
{% block body_class %}chat-page{% endblock %}

{% block content %}
<div class="chat-container">

    <!-- HEADER -->
    <div class="chat-header">
        <a href="{% url 'home' %}" class="btn-back">
            <i class="fas fa-arrow-left fa-lg"></i>
        </a>

        <div class="chat-header-avatar" data-bs-toggle="modal" data-bs-target="#ProfileModaluser">
            {% if other_user.profile.avatar %}
                <img src="{{ other_user.profile.avatar.url }}" alt="{{ other_user.username }} Avatar" class="rounded-circle">
            {% else %}
                <i class="fas fa-user fa-lg"></i>
            {% endif %}
        </div>

        <div class="chat-header-info">
            <div class="chat-header-title">
                {{ other_user.username }}
                <!-- Badge Bloqu√© -->
                {% if is_blocking %}
                    <span class="badge bg-danger ms-2" id="blocked-badge">üö´ Bloqu√©</span>
                {% endif %}
                <!-- Badge "Vous bloque" -->
                {% if is_blocked_by %}
                    <span class="badge bg-secondary ms-2">‚ö†Ô∏è Vous bloque</span>
                {% endif %}
            </div>
            <div class="chat-header-subtitle">
                {% if other_user.profile.is_online %}
                    <i class="fas fa-circle" style="font-size: 0.6rem; color: #25D366;"></i> En ligne
                {% else %}
                    Hors ligne
                {% endif %}
            </div>
        </div>
        <!-- Menu trois points -->
        <div class="chat-header-menu">
            <i class="fas fa-ellipsis-v" id="menuToggle" style="cursor:pointer;"></i>
            <div class="menu-dropdown" id="menuDropdown">
                <!--  Options de blocage -->
                {% if is_blocking %}
                    <div class="menu-item" onclick="unblockUser()">
                         D√©bloquer
                    </div>
                {% else %}
                    <div class="menu-item" onclick="blockUser()">
                         Bloquer
                    </div>
                    <div class="menu-item text-danger" onclick="reportAndBlockUser()">
                       Signaler et Bloquer
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!--  Alerte de blocage -->
    <div id="block-alert" class="alert alert-warning m-3" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i> <span id="block-alert-text"></span>
    </div>

    <!-- MESSAGES -->
    <div id="chat-messages" class="chat-messages">
        {% if messages %}
            {% for message in messages %}
                <div class="message-wrapper {% if message.sender == user %}sent{% else %}received{% endif %}" id="msg-{{ message.id }}">

                    {% if message.sender == user %}
                        <!-- Bouton de suppression -->
                        <a href="#"
                           class="icon-link icon-link-hover text-danger text-decoration-none delete-btn"
                           data-id="{{ message.id }}"
                           data-bs-toggle="modal"
                           data-bs-target="#deleteModal">
                             <i class="fas fa-trash"></i>
                        </a>
                    {% endif %}

                    <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}">
                        <div class="message-text">{{ message.content }}</div>

                        {% if message.image %}
                            <img src="{{ message.image.url }}" class="message-image img-fluid" alt="Image">
                        {% endif %}
                        {% if message.file %}
                            <div class="mt-2">
                                <a href="{{ message.file.url }}" style="color: inherit;" download>
                                    <i class="fas fa-file"></i> Fichier joint
                                </a>
                            </div>
                        {% endif %}

                        <div class="message-time">{{ message.timestamp|date:"d/m H:i" }}</div>
                        {% if message.sender == request.user and message.is_read %}
                            <small class="text-light">Vu</small>
                        {% endif %}
                    </div>

                    {% if message.sender == user %}
                        <a href="#"
                           class="icon-link icon-link-hover text-danger text-decoration-none delete-btn delete"
                           data-id="{{ message.id }}"
                           data-bs-toggle="modal"
                           data-bs-target="#deleteModal">
                            <i class="fas fa-trash"></i>
                        </a>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-chat">
                <div>
                    <i class="fas fa-comments"></i>
                    <p>Aucun message encore.<br>Commencez la conversation!</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- INPUT -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="btn-icon emoji-button" id="emoji-button" type="button" title="Emojis">
                <i class="far fa-smile"></i>
            </button>
            <emoji-picker id="emoji-picker" style="display:none; position:absolute; bottom:70px; left:60px; z-index:1000;"></emoji-picker>

            <label for="file-upload" class="btn-icon file-upload-label" title="Joindre Fichier ou Image">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="file-upload" class="file-input" accept="image/*, .pdf, .zip, .docx" hidden>
            <div id="file-preview" style="margin-top:8px; max-height:100px; overflow-y:auto;"></div>

            <input type="text" id="message-input" class="chat-input" placeholder="Tapez un message..." autocomplete="off">
            <button class="btn-send" id="send-button" type="button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Modal Bootstrap -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirmation de suppression</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Voulez-vous vraiment supprimer ce message ?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
          </div>
        </div>
      </div>
    </div>

</div>

<div class="modal fade" id="ProfileModaluser" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-profile">
        <div class="modal-header profile-header">
          <h5 class="modal-title text-white">Information sur le profile </h5>
          <button type="button" class="btn-close-profile" data-bs-dismiss="modal" aria-label="Fermer">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body profile-body">
          <div class="profile-avatar-section text-center mb-4">
            <div class="position-relative d-inline-block">
                <div class="profile-avatar-large">
                  {% if other_user.profile.avatar %}
                    <img src="{{ other_user.profile.avatar.url }}" alt="Avatar">
                  {% else %}
                    <div>
                        <i class="fas fa-user fa-3x text-secondary"></i>
                    </div>
                  {% endif %}
                </div>
            </div>
          </div>

          <div class="profile-section mb-3">
            <div class="profile-section-header">
              <span class="profile-label">Nom d'utilisateur</span>
            </div>
            <div class="profile-section-content">
              <p type="text" class="form-control-plaintext">
                {{ other_user.username }}
              </p>
            </div>
          </div>

          <div class="profile-section mb-3">
            <div class="profile-section-header">
              <span class="profile-label">√Ä propos (Bio)</span>
            </div>
            <div class="profile-section-content">
                {% with other_user.username|add:" n'a pas encore rempli sa biographie." as default_bio_message %}
                    <p type="text" class="form-control-plaintext">
                        {{ other_user.profile.bio|default:default_bio_message }}
                    </p>
                {% endwith %}
            </div>

          </div>

          <div class="profile-section">
            <div class="profile-section-header">
              <span class="profile-label">T√©l√©phone</span>
            </div>
            <div class="profile-section-content">
               {% with other_user.username|add:" n'a pas encore rempli son num√©ro de telephone." as default_phone_message %}
                    <p type="text" class="form-control-plaintext">
                        {{ other_user.profile.phone|default:default_phone_message}}
                    </p>
               {% endwith %}
            </div>
          </div>

            <div class="profile-section">
                <div class="profile-section-header">
                  <span class="profile-label">Email</span>
                </div>
                <div class="profile-section-content">
                    {% with other_user.username|add:" n'a pas encore rempli son adresse mail." as default_email_message %}
                        <p type="text" class="form-control-plaintext" >
                            {{ other_user.profile.email|default:default_email_message}}
                        </p>
                    {% endwith %}
                </div>
            </div>
            <div class="profile-section">
                <div class="profile-section-header">
                    <span class="profile-label">Derni√®re activit√©</span>
                </div>
                <div class="profile-section-content">
                    <p class="form-control-plaintext">
                        {% if other_user.profile.is_online %}
                            <span class="text-success"><i class="fas fa-circle"></i> En ligne</span>
                        {% else %}
                            Vu pour la derni√®re fois : {{ other_user.profile.last_seen|date:"d/m/Y H:i" }}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const emojiButton = document.getElementById('emoji-button');
const emojiPicker = document.getElementById('emoji-picker');
const fileInput = document.getElementById('file-upload');
const filePreview = document.getElementById('file-preview');

let selectedFile = null;
const username = "{{ user.username }}";
const otherUsername = "{{ other_user.username }}";

//  VARIABLE GLOBALE: Statut de blocage
let isBlocked = {{ is_blocking|yesno:"true,false" }} || {{ is_blocked_by|yesno:"true,false" }};

// --- WEBSOCKET ---
const chatSocket = new WebSocket(
    (window.location.protocol === 'https:' ? 'wss:' : 'ws:') +
    "//" + window.location.host + "/ws/chat/private/{{ other_user.username }}/"
);

// --- √âCHAPPEMENT HTML ---
function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// --- AJOUT MESSAGE EN TEMPS R√âEL ---
function addMessageToDOM(data){
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${data.sender === username ? 'sent' : 'received'}`;
    wrapper.id = `msg-${data.id}`;

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${data.sender === username ? 'sent' : 'received'}`;
    bubble.innerHTML = `<div class="message-text">${escapeHtml(data.message)}</div>
                        <div class="message-time">${data.timestamp}</div>`;
    wrapper.appendChild(bubble);

    if(data.sender === username){
        const a = document.createElement('a');
        a.href = "#";
        a.className = "icon-link icon-link-hover text-danger text-decoration-none delete-btn delete";
        a.dataset.id = data.id;
        a.setAttribute('data-bs-toggle','modal');
        a.setAttribute('data-bs-target','#deleteModal');
        a.innerHTML = '<i class="fas fa-trash"></i>';
        a.addEventListener('click', handleDeleteClick);
        wrapper.appendChild(a);
    }

    chatMessages.appendChild(wrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// --- GESTION SUPPRESSION ---
let messageIdToDelete = null;
function handleDeleteClick(e){
    e.preventDefault();
    messageIdToDelete = this.dataset.id;
}

// Ajouter l'√©couteur √† tous les liens delete existants
document.querySelectorAll('.delete-btn').forEach(link => link.addEventListener('click', handleDeleteClick));

// Confirmation suppression
document.getElementById('confirmDeleteBtn').addEventListener('click', ()=>{
    if(!messageIdToDelete) return;

    chatSocket.send(JSON.stringify({
        type: "delete_message",
        message_id: messageIdToDelete
    }));

    const msg = document.getElementById("msg-" + messageIdToDelete);
    if(msg) msg.remove();

    messageIdToDelete = null;
    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
});

//  FONCTION: V√©rifier le statut de blocage
function checkBlockStatus() {
    if (isBlocked) {
        messageInput.disabled = true;
        sendButton.disabled = true;
        messageInput.placeholder = 'üö´ Impossible d\'envoyer des messages';

        const alertBox = document.getElementById('block-alert');
        const alertText = document.getElementById('block-alert-text');
        alertText.textContent = 'Communication bloqu√©e avec cet utilisateur.';
        alertBox.style.display = 'block';
    }
}

// V√©rifier au chargement de la page
checkBlockStatus();

// --- ENVOI MESSAGE ---
function sendMessage(){
    //  V√©rifier si bloqu√© avant d'envoyer
    if (isBlocked) {
        alert('Impossible d\'envoyer des messages. Communication bloqu√©e.');
        return;
    }

    const text = messageInput.value.trim();

    if(selectedFile){
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('receiver_username', otherUsername);
        if(text) formData.append('content', text);

        fetch("{% url 'upload_file' %}",{
            method:'POST',
            headers:{'X-CSRFToken':'{{ csrf_token }}'},
            body: formData
        }).then(res=>res.json())
        .then(data=>{
            if(data.status==='success'){
                chatSocket.send(JSON.stringify({
                    message: text||'',
                    file_url: data.file_url,
                    image_url: data.image_url
                }));
                selectedFile=null;
                filePreview.innerHTML='';
                messageInput.value='';
            } else alert(data.message);
        }).catch(err=>console.error(err));
    } else if(text){
        chatSocket.send(JSON.stringify({type:'message', message:text}));
        messageInput.value='';
    }
}
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', e=>{if(e.key==='Enter') sendMessage();});

// --- FILE + PREVIEW ---
fileInput.addEventListener('change', function(){
    filePreview.innerHTML='';
    selectedFile = this.files[0];
    if(!selectedFile) return;

    const p = document.createElement('p');
    p.textContent = 'üìé ' + selectedFile.name;
    filePreview.appendChild(p);

    if(selectedFile.type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(selectedFile);
        img.style.maxWidth='100px';
        img.style.maxHeight='80px';
        img.style.marginTop='4px';
        filePreview.appendChild(img);
    }
});

// --- EMOJI PICKER ---
emojiButton.addEventListener('click', ()=>emojiPicker.style.display = (emojiPicker.style.display==='none'?'block':'none'));
emojiPicker.addEventListener('emoji-click', e=>messageInput.value+=e.detail.unicode);
document.addEventListener('click', e=>{
    if(!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)){
        emojiPicker.style.display='none';
    }
});

// --- RECEVOIR MESSAGE ---
chatSocket.onmessage = function(e){
    const data = JSON.parse(e.data);

    if(data.type==='message') addMessageToDOM(data);
    if(data.type==='delete_message'){
        const msg = document.getElementById("msg-"+data.message_id);
        if(msg) msg.remove();
    }
    //  G√©rer les erreurs de blocage
    if(data.type==='error' && data.blocked){
        alert(data.message);
        isBlocked = true;
        checkBlockStatus();
    }
};

//  FONCTION: R√©cup√©rer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

//  FONCTION: Bloquer un utilisateur
function blockUser() {
    if (!confirm(`Voulez-vous vraiment bloquer ${otherUsername}?`)) {
        return;
    }

    fetch(`/block/${otherUsername}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Recharger pour afficher le badge
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    });
}

//  FONCTION: D√©bloquer un utilisateur
function unblockUser() {
    if (!confirm(`Voulez-vous vraiment d√©bloquer ${otherUsername}?`)) {
        return;
    }

    fetch(`/unblock/${otherUsername}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    });
}

//  FONCTION: Signaler + Bloquer (masquer conversation)
function reportAndBlockUser() {
    const reason = prompt('Raison du signalement:\n\n1. Spam\n2. Harc√®lement\n3. Contenu inappropri√©\n4. Faux profil\n5. Autre\n\nEntrez le num√©ro (1-5):');

    if (!reason) return;

    const reasonMap = {
        '1': 'spam',
        '2': 'harassment',
        '3': 'inappropriate',
        '4': 'fake',
        '5': 'other'
    };

    const selectedReason = reasonMap[reason] || 'other';
    const description = prompt('Description (optionnel):') || '';

    const formData = new FormData();
    formData.append('reason', selectedReason);
    formData.append('description', description);

    fetch(`/report-and-block/${otherUsername}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Rediriger vers la page d'accueil car la conversation est masqu√©e
            window.location.href = '/home';
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue');
    });
}

// --- MENU TOGGLE ---
const menuToggle=document.getElementById('menuToggle');
const menuDropdown=document.getElementById('menuDropdown');
menuToggle.addEventListener('click',()=>menuDropdown.style.display=menuDropdown.style.display==='block'?'none':'block');
document.addEventListener('click', e=>{
    if(!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) menuDropdown.style.display='none';
});
</script>

<style>
.message-wrapper{position:relative;}
.delete-btn{position:absolute;top:5px;right:5px;display:none;}
.message-wrapper:hover .delete-btn{display:block;}
</style>
{% endblock %}