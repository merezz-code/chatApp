{% extends 'chat/base.html' %}

{% block title %}{{ other_user.username }} - ChatApp{% endblock %}
{% block body_class %}chat-page{% endblock %}

{% block content %}
<div class="chat-container">

    <!-- HEADER -->
    <div class="chat-header">
        <a href="{% url 'home' %}" class="btn-back">
            <i class="fas fa-arrow-left fa-lg"></i>
        </a>
        <div class="chat-header-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="chat-header-info">
            <div class="chat-header-title">{{ other_user.username }}</div>
            <div class="chat-header-subtitle">
                {% if other_user.profile.is_online %}
                    <i class="fas fa-circle" style="font-size: 0.6rem; color: #25D366;"></i> En ligne
                {% else %}
                    Hors ligne
                {% endif %}
            </div>
        </div>
        <div class="chat-header-menu">
            <i class="fas fa-ellipsis-v" id="menuToggle" style="cursor:pointer;"></i>
            <div class="menu-dropdown" id="menuDropdown">
                {% if room.is_group %}
                    <div class="menu-item" onclick="leaveGroup({{ room.id }})">Quitter le groupe</div>
                {% else %}
                    <div class="menu-item" onclick="blockUser({{ other_user.id }})">Bloquer</div>
                {% endif %}
                <div class="menu-item" onclick="reportChat({{ room.id }})">Signaler</div>
            </div>
        </div>
    </div>

    <!-- MESSAGES -->
    <div id="chat-messages" class="chat-messages">
        {% if messages %}
            {% for message in messages %}
                <div class="message-wrapper {% if message.sender == user %}sent{% else %}received{% endif %}" id="msg-{{ message.id }}">
                    <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}">
                        <div class="message-text">{{ message.content }}</div>

                        {% if message.image %}
                            <img src="{{ message.image.url }}" class="message-image img-fluid" alt="Image">
                        {% endif %}
                        {% if message.file %}
                            <div class="mt-2">
                                <a href="{{ message.file.url }}" style="color: inherit;" download>
                                    <i class="fas fa-file"></i> Fichier joint
                                </a>
                            </div>
                        {% endif %}
                        <div class="message-time">{{ message.timestamp|date:"d/m H:i" }}</div>
                        {% if message.sender == request.user and message.is_read %}
                            <small class="text-light">Vu</small>
                        {% endif %}
                    </div>

                    {% if message.sender == user %}
                    <a href="#"
                       class="icon-link icon-link-hover text-danger text-decoration-none delete-btn delete"
                       data-id="{{ message.id }}"
                       data-bs-toggle="modal"
                       data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i>
                    </a>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-chat">
                <div>
                    <i class="fas fa-comments"></i>
                    <p>Aucun message encore.<br>Commencez la conversation!</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- INPUT -->
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="btn-icon emoji-button" id="emoji-button" type="button" title="Emojis">
                <i class="far fa-smile"></i>
            </button>
            <emoji-picker id="emoji-picker" style="display:none; position:absolute; bottom:70px; left:60px; z-index:1000;"></emoji-picker>

            <label for="file-upload" class="btn-icon file-upload-label" title="Joindre Fichier ou Image">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="file-upload" class="file-input" accept="image/*, .pdf, .zip, .docx" hidden>
            <div id="file-preview" style="margin-top:8px; max-height:100px; overflow-y:auto;"></div>

            <input type="text" id="message-input" class="chat-input" placeholder="Tapez un message..." autocomplete="off">
            <button class="btn-send" id="send-button" type="button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Modal Bootstrap -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirmation de suppression</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Voulez-vous vraiment supprimer ce message ?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
          </div>
        </div>
      </div>
    </div>

<!-- Modal de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirmation de suppression</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Voulez-vous vraiment supprimer ce message ?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form id="deleteMessageForm" method="post" style="display:none;">
            {% csrf_token %}
        </form>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Supprimer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de signalement -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header">
        <h5 class="modal-title" id="reportModalLabel">Signaler {{ other_user.username }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="report-reason" class="form-label">Raison du signalement</label>
          <select class="form-select" id="report-reason">
            <option value="spam">Spam ou publicit√©</option>
            <option value="harassment">Harc√®lement</option>
            <option value="inappropriate">Contenu inappropri√©</option>
            <option value="fake">Faux profil</option>
            <option value="other">Autre</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="report-description" class="form-label">Description (optionnel)</label>
          <textarea class="form-control" id="report-description" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-warning" id="confirmReportBtn">Signaler</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Signaler ET Bloquer -->
<div class="modal fade" id="reportAndBlockModal" tabindex="-1" aria-labelledby="reportAndBlockModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="reportAndBlockModalLabel">‚ö†Ô∏è Signaler et Bloquer</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Cette action va :</strong></p>
        <ul>
          <li>Signaler {{ other_user.username }} aux administrateurs</li>
          <li>Bloquer compl√®tement la communication</li>
          <li><strong>Masquer d√©finitivement cette conversation</strong></li>
        </ul>
        <div class="mb-3">
          <label for="report-block-reason" class="form-label">Raison du signalement</label>
          <select class="form-select" id="report-block-reason">
            <option value="spam">Spam ou publicit√©</option>
            <option value="harassment">Harc√®lement</option>
            <option value="inappropriate">Contenu inappropri√©</option>
            <option value="fake">Faux profil</option>
            <option value="other">Autre</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="report-block-description" class="form-label">Description</label>
          <textarea class="form-control" id="report-block-description" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmReportAndBlockBtn">Signaler et Bloquer</button>
      </div>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const emojiButton = document.getElementById('emoji-button');
const emojiPicker = document.getElementById('emoji-picker');
const fileInput = document.getElementById('file-upload');
const filePreview = document.getElementById('file-preview');

let selectedFile = null;
const username = "{{ user.username }}";

// --- WEBSOCKET ---
const chatSocket = new WebSocket(
    (window.location.protocol === 'https:' ? 'wss:' : 'ws:') +
    "//" + window.location.host + "/ws/chat/private/{{ other_user.username }}/"
);

// --- √âCHAPPEMENT HTML ---
function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// --- AJOUT MESSAGE EN TEMPS R√âEL ---
function addMessageToDOM(data){
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${data.sender === username ? 'sent' : 'received'}`;
    wrapper.id = `msg-${data.id}`;

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${data.sender === username ? 'sent' : 'received'}`;
    bubble.innerHTML = `<div class="message-text">${escapeHtml(data.message)}</div>
                        <div class="message-time">${data.timestamp}</div>`;
    wrapper.appendChild(bubble);

    if(data.sender === username){
        const a = document.createElement('a');
        a.href = "#";
        a.className = "icon-link icon-link-hover text-danger text-decoration-none delete-btn delete";
        a.dataset.id = data.id;
        a.setAttribute('data-bs-toggle','modal');
        a.setAttribute('data-bs-target','#deleteModal');
        a.innerHTML = '<i class="fas fa-trash"></i>';
        a.addEventListener('click', handleDeleteClick);
        wrapper.appendChild(a);
    }

    chatMessages.appendChild(wrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// --- Gestion emoji ---
emojiButton.addEventListener('click', () => {
    emojiPicker.style.display = (emojiPicker.style.display === 'none' || emojiPicker.style.display === '') ? 'block' : 'none';
});
const picker = document.getElementById('emoji-picker');
    picker.addEventListener('emoji-click', event => {
      messageInput.value += event.detail.unicode;
    });
    document.addEventListener('click', (e) => {
    if (!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)) {
        emojiPicker.style.display = 'none';
    }
});

// Confirmation suppression
document.getElementById('confirmDeleteBtn').addEventListener('click', ()=>{
    if(!messageIdToDelete) return;

    chatSocket.send(JSON.stringify({
        type: "delete_message",
        message_id: messageIdToDelete
    }));

    const msg = document.getElementById("msg-" + messageIdToDelete);
    if(msg) msg.remove();

    messageIdToDelete = null;
    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
});

// --- ENVOI MESSAGE ---
function sendMessage(){
    const text = messageInput.value.trim();

    if(selectedFile){
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('receiver_username', "{{ other_user.username }}");
        if(text) formData.append('content', text);

        fetch("{% url 'upload_file' %}",{
            method:'POST',
            headers:{'X-CSRFToken':'{{ csrf_token }}'},
            body: formData
        }).then(res=>res.json())
        .then(data=>{
            if(data.status==='success'){
                chatSocket.send(JSON.stringify({
                    message: text||'',
                    file_url: data.file_url,
                    image_url: data.image_url
                }));
                selectedFile=null;
                filePreview.innerHTML='';
                messageInput.value='';
            } else alert(data.message);
        }).catch(err=>console.error(err));
    } else if(text){
        chatSocket.send(JSON.stringify({type:'message', message:text}));
        messageInput.value='';
    }
}
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', e=>{if(e.key==='Enter') sendMessage();});

// --- FILE + PREVIEW ---
fileInput.addEventListener('change', function(){
    filePreview.innerHTML='';
    selectedFile = this.files[0];
    if(!selectedFile) return;

    const p = document.createElement('p');
    p.textContent = 'üìé ' + selectedFile.name;
    filePreview.appendChild(p);

    if(selectedFile.type.startsWith('image/')){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(selectedFile);
        img.style.maxWidth='100px';
        img.style.maxHeight='80px';
        img.style.marginTop='4px';
        filePreview.appendChild(img);
    }
});

// --- EMOJI PICKER ---
emojiButton.addEventListener('click', ()=>emojiPicker.style.display = (emojiPicker.style.display==='none'?'block':'none'));
emojiPicker.addEventListener('emoji-click', e=>messageInput.value+=e.detail.unicode);
document.addEventListener('click', e=>{
    if(!emojiButton.contains(e.target) && !emojiPicker.contains(e.target)){
        emojiPicker.style.display='none';
    }
});

// --- RECEVOIR MESSAGE ---
chatSocket.onmessage = function(e){
    const data = JSON.parse(e.data);

    if(data.type==='message') addMessageToDOM(data);
    if(data.type==='delete_message'){
        const msg = document.getElementById("msg-"+data.message_id);
        if(msg) msg.remove();
    }
};

// --- MENU TOGGLE ---
const menuToggle=document.getElementById('menuToggle');
const menuDropdown=document.getElementById('menuDropdown');
menuToggle.addEventListener('click',()=>menuDropdown.style.display=menuDropdown.style.display==='block'?'none':'block');
document.addEventListener('click', e=>{
    if(!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) menuDropdown.style.display='none';
});
</script>

<style>
.message-wrapper{position:relative;}
.delete-btn{position:absolute;top:5px;right:5px;display:none;}
.message-wrapper:hover .delete-btn{display:block;}
</style>
{% endblock %}
